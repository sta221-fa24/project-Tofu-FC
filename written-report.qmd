---
title: "Mushroom Edibility Analysis"
author: "Tofu-FC - Huiwen Wang, Rocky Zhang, Darrick Zhang"
date: "10,28,24"
format: pdf
execute: 
  warning: false
  message: false
  echo: false
editor: visual
bibliography: references.bib
---

```{r}
#| label: load packages and data

library(tidyverse)
library(tidymodels)
library(dbplyr)
library(knitr)
library(GGally)
library(gridExtra)
library(caTools) # might need to install
library(caret) # might need to install
library(grid)
# add other packages as needed

mushrooms <- read.csv2("data/mushrooms_dataset.csv")

# Make Quantitative data numerical
mushrooms$cap.diameter <- as.numeric(mushrooms$cap.diameter)
mushrooms$stem.height <- as.numeric(mushrooms$stem.height)
mushrooms$stem.width <- as.numeric(mushrooms$stem.width)

# Convert the response variable to binary (e = 0, p = 1)
mushrooms <- mushrooms |>
  mutate(
    class_binary = ifelse(mushrooms$class == "e", 0, 1)
  )
```

## Introduction

### Project Motivation / Background:

Mushrooms are vital to the general wellness of the ecosystem, decomposing and recycling the nutrients in the soil. Mushrooms also provide a valuable food source full of nutrients for human beings and other important organisms. However, some mushroom species can also be poisonous and harmful.

The importance of this research has been highlighted in a multitude of studies. Take this quote, for example:

> The ingestion of wild and potentially toxic mushrooms is common in the United States, with poison centers logging cases in the National Poison Data System (NPDS) for over 30 years. From 1999 to 2016, there were 133,700 reported cases of mushroom exposure, mostly unintentional and involving children under six years old. While the majority of cases resulted in no or minor harm, there were 704 instances of major harm and 52 fatalities, primarily due to cyclopeptide-producing mushrooms ingested unintentionally by older adults. Misidentification of edible mushroom species is a common cause of poisoning and may be preventable through education [@brandenburgward2018].

As shown by studies and other similar studies, accurate classification of mushrooms is crucial for preventing poisoning incidents. Many toxic mushroom species closely resemble edible varieties, making it easy for foragers to misidentify them. Thus, our research will focus on what physical features and environmental factors of mushrooms humans can use to identify toxic/poisonous mushrooms in the wild. By conducting a research study on how to distinguish between safe and dangerous species, we can mitigate the incidence of mushroom poisoning and ensure safer foraging practices.

### Research Question:

What environmental factors and/or physical features of mushrooms indicate that a wild mushroom is poisonous?

### Hypothesis:

Mushrooms in the wild with obvious physical features like white gills, white rings, red caps, or red stems tend to be poisonous. These obvious physical traits are more likely to be spotted by animals, which would provide an evolutionary disadvantage unless they contain certain self-defense mechanisms, such as poison or toxins. Additionally, the habitat and season in which mushrooms are planted and grow may also affect whether they're poisonous. Different temperatures, humidity, and light can affect the production of toxins, which may also affect the edibility of mushrooms.

### Data Description:

The data was curated on April 26, 1987, and submitted to the UCI by the National Audubon Society Field Guide. The National Audubon Society conducted extensive field research throughout North America, recording their observations on various aspects of mushrooms. Their research incorporate a wide range of physical characteristics, including size, shape, color, and texture of the mushrooms. Additionally, they documented environmental factors such as the type of habitat and seasonal variations. Importantly, the study also focused on the toxicity of the mushrooms, noting which species were poisonous. This comprehensive dataset provides valuable insights into the relationship between mushrooms and their environments, contributing significantly to the understanding of the factors influencing mushroom toxicity.

Our response variable is `class`, which is a qualitative variable labeled "e" for edible or "p" for poisonous.

Key quantitative predictor variables include `stem.height` and `stem.width`, the height (cm) and width (cm) of the stem of the mushroom. We are also interested in `cap.diameter`, the diameter of the mushroom cap (cm).

Key qualitative predictor variables include `cap.shape`, the shape of the mushroom cap; `gill.color`, the color of the fungi gills, `stem.color`, the color of the mushroom stem; `habitat`, the habitat that the mushroom is grown/found; and `season`, the season that the mushroom is grown/found (spring=s, summer=u, autumn=a, winter=w).

The `cap.shape` codes are:

| b    | c       | x      | f    | s      | p         | o      |
|------|---------|--------|------|--------|-----------|--------|
| bell | conical | convex | flat | sunken | spherical | others |

The `gill.color` and `stem.color` are:

| n     | b    | g    | r     | p    | u      | e   | w     | y      | l    | o      | k     | f    |
|------|------|------|------|------|------|------|------|------|------|------|------|------|
| brown | buff | gray | green | pink | purple | red | white | yellow | blue | orange | black | none |

The `habitat` codes are:

| g       | l      | m       | p     | h      | u     | w     | d     |
|---------|--------|---------|-------|--------|-------|-------|-------|
| grasses | leaves | meadows | paths | heaths | urban | waste | woods |

## Exploratory Data Analysis

```{r}
#| label: check rows

# # Count the number of rows with at least one missing value
# num_missing_rows <- sum(rowSums(is.na(mushrooms)) > 0)
# cat("Number of rows with at least one missing value:", num_missing_rows, "\n")
```

```{r}
#| label: univariate response variable, summary statistics

#EDA Response (Categorical) Variable
ggplot(mushrooms, aes(x = class, fill = class)) +
  geom_bar() +
  theme_minimal() +
  labs(
    title = "Distribution of Edibility/Classes of Mushrooms",
    x = "Class",
    caption = "44.5% are edible, 55.5% are poisonous"
  ) +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5)

# Summary Statistics
# mushrooms |>
#  group_by(class) |>
#  summarise(
#    count = n(),
#    percentage = (count / nrow(mushrooms)) * 100
#  ) |> kable(digits=3)
```

Looking at the overall distribution of our response variable `class`, most of the mushrooms in our dataset seem to be poisonous ("p"). 33888 of the observations, or 55.5% of them are labeled poisonous, as opposed to 27181 (44.5%) of them as edible.

```{r}
#| label: multicolinearity

mushrooms |>
  select(cap.diameter, stem.height, stem.width) |>
  ggpairs()

mushrooms |>
  summarise(min = min(cap.diameter), 
            q1 = quantile(cap.diameter, 0.25), 
            median = median(cap.diameter),
            q3 = quantile(cap.diameter, 0.75), 
            max = max(cap.diameter),
            mean = mean(cap.diameter),
            sd = sd(cap.diameter)) |>
  kable(digits = 3, 
        caption = "cap diameter summary statistics")

mushrooms |>
  summarise(min = min(stem.height), 
            q1 = quantile(stem.height, 0.25), 
            median = median(stem.height),
            q3 = quantile(stem.height, 0.75), 
            max = max(stem.height),
            mean = mean(stem.height),
            sd = sd(stem.height)) |>
  kable(digits = 3,
        caption = "stem height summary statistics")

mushrooms |>
  summarise(min = min(stem.width), 
            q1 = quantile(stem.width, 0.25), 
            median = median(stem.width),
            q3 = quantile(stem.width, 0.75), 
            max = max(stem.width),
            mean = mean(stem.width),
            sd = sd(stem.width)) |>
  kable(digits = 3,
        caption = "stem width summary statistics")

# final predictors <- c("cap.diameter", "cap.shape", "gill.color",
#                 "stem.color", "habitat", "season")
# response_var <- "class"
```

We were first interested in seeing the relationship between our continuous, quantitative variables. While not totally linear, with correlations of $0.423$ and $0.436$, they graphs seem to be somewhat linear, with some redundancy in their information. Thus, for the rest of the EDA we will focus mainly on visualizing `cap.diameter`. We may consider adding them back for the final model, but were more interested in seeing some of the EDA with the categorical variables. The mean cap diameter is 6.734cm, with a SD of 5.265cm. The mean stem height is 6.582cm, with a SD of 3.37cm. The mean stem width is 12.149cm, with a SD of 10.036cm.

```{r}
#| label: univariate predictors

p1 <- ggplot(mushrooms, aes(x = cap.diameter)) +
    geom_histogram() +
  geom_vline(xintercept=mean(mushrooms$cap.diameter), color="red") +
    theme_minimal() +
    labs(title = "Cap diameter",
         x="Cap diameter",
         caption = "mean: 6.734; SD: 5.265")
p2 <- ggplot(mushrooms, aes(x = cap.shape)) +
    geom_bar() +
    theme_minimal() +
    labs(title = "Cap shape",
         x="Cap shape")
p3 <- ggplot(mushrooms, aes(x = gill.color)) +
    geom_bar() +
    theme_minimal() +
    labs(title = "Gill color",
         x="Gill color")
p4 <- ggplot(mushrooms, aes(x = stem.color)) +
    geom_bar() +
    theme_minimal() +
    labs(title = "Stem color",
         x="Stem color")
p5 <- ggplot(mushrooms, aes(x = habitat)) +
    geom_bar() +
    theme_minimal() +
    labs(title = "Habitat",
         x="Habitat")
p6 <- ggplot(mushrooms, aes(x = season)) +
    geom_bar() +
    theme_minimal() +
    labs(title = "Season",
         x="Season")
grid.arrange(p1,p2,p3,p4,p5,p6,
              bottom = textGrob("cap shape: bell=b, conical=c, convex=x, flat=f, sunken=s, spherical=p, others=o
colors: brown=n, buff=b, gray=g, green=r, pink=p, purple=u, red=e, white=w, yellow=y, blue=l, orange=o, black=k
habitat: grasses=g, leaves=l, meadows=m, paths=p, heaths=h, urban=u, waste=w, woods=d
season: spring=s, summer=u, autumn=a, winter=w", 
                                                 gp = gpar(fontsize = 8)))
```

To visualize the distribution of some of our predictor variables, we use a histogram for our continuous variable `cap.diameter` and bar graphs for our categorical variables. The distribution of cap diameter seems to be unimodal, skewed right. From the For qualitative variables, there appears to be more common physical and environmental characteristics. For cap shape, flat and convex tends to be the most common; for stem root the most common was "missing data" (which likely suggests that this may be a variable to remove); for stem color the most common is white, yellow, and brown; for habitat, woods is the most common (see above for code meanings); for season, autumn and summer tends to be the most common.

```{r}
#| label: bivariate EDA
g1 <- ggplot(mushrooms, aes(x = cap.diameter, color = class)) +
    geom_boxplot() +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs cap diameter",
         x = "Cap diameter")
g2 <- ggplot(mushrooms, aes(x = cap.shape, fill = class)) +
    geom_bar(position = "dodge") +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs cap shape",
         x = "Cap shape")
g3 <- ggplot(mushrooms, aes(x = gill.color, fill = class)) +
    geom_bar(position = "dodge") +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs gill color",
         x = "Gill color")
# g3 <- ggplot(mushrooms, aes(x = stem.root, fill = class)) +
#     geom_bar(position = "dodge") +
#     labs(title = "Response vs stem root")
g4 <- ggplot(mushrooms, aes(x = stem.color, fill = class)) +
    geom_bar(position = "dodge") +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs stem color",
         x ="Stem color")
g5 <- ggplot(mushrooms, aes(x = habitat, fill = class)) +
    geom_bar(position = "dodge") +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs habitat",
         x = "Habitat")
g6 <- ggplot(mushrooms, aes(x = season, fill = class)) +
    geom_bar(position = "dodge") +
    theme(legend.title = element_blank()) +
    labs(title = "Response vs season",
         x = "Season")

grid.arrange(g1,g2,g3,g4,g5,g6,bottom = textGrob("cap shape: bell=b, conical=c, convex=x, flat=f, sunken=s, spherical=p, others=o
colors: brown=n, buff=b, gray=g, green=r, pink=p, purple=u, red=e, white=w, yellow=y, blue=l, orange=o, black=k
habitat: grasses=g, leaves=l, meadows=m, paths=p, heaths=h, urban=u, waste=w, woods=d
season: spring=s, summer=u, autumn=a, winter=w",
                                                 gp = gpar(fontsize = 8)))
```

The bivariate exploratory data analysis also shows some interesting findings for predictors. In particular, categories that have a disparity between the two different classes could offer potential modeling power in classification of the classes (toxicity). Larger, more extreme cap diameter is often linked to edibility. Cap shape of convex, bell, and others is more likely to be poisonous/toxic than edible. We also see that gill color of brown and yellow tends to be poisonous. For stem color, yellow and brown tends to be more poisonous than not. And lastly the habitat of woods and the season of autumn and summer also observes a similar observation.

```{r}
#| label: analysis of interaction

ggplot(mushrooms, aes(x = habitat, fill = class)) +
  geom_bar(position = "fill") + 
  facet_wrap(~ season) +
  labs(title = "Edibility Distribution by Habitat and Season",
       x = "Habitat",
       y = "Proportion of Edibility",
       caption = "Habitat codes: grasses=g, leaves=l, meadows=m, paths=p, heaths=h, urban=u, waste=w, woods=d
       Season codes: spring=s, summer=u, autumn=a, winter=w") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

mushroom_prop <- mushrooms |>
  group_by(cap.color, cap.shape) |> 
  summarize(edible_count = sum(class == "e"),
            poisonous_count = sum(class == "p")) |>
  mutate(proportion_e_to_p = edible_count / poisonous_count) |>
  select(cap.color, cap.shape, proportion_e_to_p)
mushroom_prop <- mushroom_prop |>
  mutate(log_prop = log(proportion_e_to_p))

caption_msg <- "'e' denotes always edible
                'p' denotes always poisonous
                Cap shape codes: bell=b, conical=c, convex=x, flat=f, sunken=s, spherical=p, others=o
                Cap color codes: brown=n, buff=b, gray=g, green=r, pink=p, purple=u, red=e, white=w, yellow=y, blue=l, orange=o, black=k"


ggplot(mushroom_prop, aes(x = cap.color, y = cap.shape, 
                          fill = log_prop)) +
  geom_tile() +
  labs(title = "Cap Color and Shape Combinations by Edibility",
       subtitle = 
         "Using log ratios of edible to poisonous mushrooms",
       x = "Cap Color",
       y = "Cap Shape",
       fill = "log(e/p)",
       caption = caption_msg) +
  geom_tile(data = mushroom_prop |>
              filter(log_prop == -Inf),
            aes(y = cap.shape, x = cap.color),
            fill = "firebrick1") +
  geom_tile(data = mushroom_prop |>
              filter(log_prop == Inf),
            aes(y = cap.shape, x = cap.color),
            fill = "darkseagreen2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  geom_text(aes(label = case_when(
                          log_prop == Inf ~ "e",
                          log_prop == -Inf ~ "p",
                          TRUE ~ as.character(round(log_prop, 1)))),
            color = "black")
```

We believe that these predictors may have potential interactive effects that could help us with our model to predict edibility of mushrooms due to the fact that certain more specific characteristics tends to be poisonous.

**Habitat × Season**: Our EDA reveals that mushrooms in certain habitats might only be edible during specific seasons. For example, mushrooms in the meadows are edible in the winter, but may be poisonous in other seasons.

**Cap color × Cap shape**: Certain combinations of cap color and cap shape are always edible or poisonous. Additionally, the log ratios across combinations of cap colors and cap sizes are varied with no pattern – for a mushroom with a sunken cap shape, it could be always edible (if the color is buff) to always poisonous (if the color is red). Similarly, if a mushroom is brown, it could be high likely it is edible (if the cap shape is conical) or likely it is poisonous (if the cap shape is bell).

```{r}
#| label: multivariate EDA
ggplot(mushrooms, aes(y = stem.height, x = stem.width, color = class)) +
  geom_point() +
  labs(
    title = "Distribution of Stem Height vs. Stem Width Among Different Edibility Classes",
    y = "Stem Height (cm)",
    x = "Stem Width (cm)",
    color = "Class (Edibile or Not)"
  ) +
  theme_minimal()
```

Finally, we look at multivariate data analysis including 2 predictors and our response variable. Here, we visualize the effect of both stem width and stem height on the response variable, `class`. Interestingly, it seems like mushrooms with either high stem width or stem height seem to be edible. This suggests there may be some potential interaction effects between stem height and stem width – the low value of one alone does not seem to predict if the mushroom is poisonous, but requires the low value of both.

## Analysis

The base model:

$$
\log\left(\frac{\text{P}(\text{class = poisonous})}{\text{P}(\text{class = edible})}\right) = \beta_0 + \beta_1 \cdot \text{cap.diameter} + \beta_2 \cdot \text{season} + \beta_3 \cdot \text{cap.shape} + \beta_4 \cdot \text{cap.color} \\+ \beta_5 \cdot \text{gill.color} + \beta_6 \cdot \text{stem.color} + \beta_7 \cdot \text{habitat}
$$

Predictor terms were chosen from exploratory data analysis and general physical or environmental factors that are generally understood and easy to evaluate by everyone. To determine the usefulness of these selected predictor terms a likelihood ratio test was performed.

```{r}
#| label: Overall Significance F Test (Likelihood Ratio Test)
null_model <- glm(class_binary ~ 1, data = mushrooms, family = "binomial")
main_model <- glm(class_binary ~ cap.diameter + season + cap.shape + cap.color +
                    gill.color + stem.color + habitat, 
                    data = mushrooms, family = "binomial")
(L_0 <- glance(null_model)$logLik)
(L_a <- glance(main_model)$logLik)
(G <- -2 * (L_0 - L_a)) #LRT test statistic
(p_value <- pchisq(G, df = 3, lower.tail = FALSE))
anova(null_model, main_model, test = "Chisq") |> 
  tidy() |> 
  kable(digits = 3)
```

$$
H_0: \beta_j = 0 \\ H_a: \beta_j \neq 0 \ for\ at\ least\ 1\ j
$$

Since the p-value is small, and less than $\alpha = 0.05$, we reject the $H_0$. The data provide sufficent evidence of at least one non-zero coefficient in the model.

To determine adding interaction terms, a drop in deviance test was performed with the added interaction terms of habitat \* seasonand cap.shape \* cap.color.

#what if we remove cap.diameter and kept stem height and width, and had an interaction term of the two?

#Why is df so high?

#High p-values in tidy table of full_model? Is that a point of concern?

```{r}
#| label: Drop-in-deviance Testca

full_model <- glm(class_binary ~ cap.diameter + season + cap.shape + cap.color +
                    gill.color + stem.color + habitat + habitat*season + 
                    cap.shape*cap.color,
                    data = mushrooms, family = "binomial")

anova(main_model, full_model, test = "Chisq") |> 
  tidy() |> 
  kable(digits = 3)
```

Since the p-value is low, below $\alpha = 0.05$, we decide to include these interaction terms as there is convincing evidence that at least one of these interactive term coefficients are not 0 and thus helpful in the model.

Additionally, we looked at BIC and BIC to evaluate the base model in comparison with the interactive model.

```{r}
glance(main_model)$AIC
glance(full_model)$AIC
glance(main_model)$BIC
glance(full_model)$BIC
```

For both AIC and BIC, the model with the interaction effect does much better in comparison to the main model.

```{r}
#| label: more interactino effects/vars?

full_model2 <- glm(class_binary ~ cap.diameter + season + cap.shape + cap.color +
                    gill.color + habitat + stem.root*stem.color + veil.type + veil.color +
                     has.ring + ring.type +
                     cap.shape*cap.color + habitat*season,
                   data = mushrooms, family="binomial")
full_model3 <- glm(class_binary ~ cap.diameter + season + cap.shape + cap.color +
                     gill.color + habitat + stem.root*stem.color + veil.type + veil.color + 
                     has.ring*ring.type +gill.attachment*gill.spacing+
                     cap.shape*cap.color + habitat*season,
                   data = mushrooms, family="binomial")
anova(full_model2, full_model3, test = "Chisq") |> 
  tidy() |> 
  kable(digits = 3)

test_data$class_binary <- as.factor(test_data$class_binary)
predicted_values <- predict(full_model2, test_data, type = "response")
test_data <- test_data |> 
  mutate(pred_prob = predicted_values)

roc_curve_data <- test_data |>
  roc_curve(class_binary, pred_prob, event_level = "second")
autoplot(roc_curve_data)

test_data_aug <- augment(full_model2, newdata = test_data)
test_data_aug$class_binary <- as.factor(test_data_aug$class_binary)
test_data_aug |>
  roc_auc(class_binary, .fitted, event_level = "second")

test_data$class_binary <- as.factor(test_data$class_binary)
predicted_values <- predict(full_model3, test_data, type = "response")
test_data <- test_data |> 
  mutate(pred_prob = predicted_values)

roc_curve_data <- test_data |>
  roc_curve(class_binary, pred_prob, event_level = "second")
autoplot(roc_curve_data)

test_data_aug <- augment(full_model3, newdata = test_data)
test_data_aug$class_binary <- as.factor(test_data_aug$class_binary)
test_data_aug |>
  roc_auc(class_binary, .fitted, event_level = "second")

glance(full_model2)$AIC
glance(full_model3)$AIC
glance(full_model2)$BIC
glance(full_model3)$BIC
```

## Model Results

```{r}

set.seed(123)  # for reproducibility
split <- sample.split(mushrooms$class_binary, SplitRatio = 0.7)
train_data <- subset(mushrooms, split == TRUE)
test_data <- subset(mushrooms, split == FALSE)

tidy(full_model) |>
  kable(digits = 3)
```

### Final Model

$$
\text{log}(\text{Odds}(\text{class_binary} = p)) = \beta_0 + \beta_1 \cdot \text{cap.diameter} + \beta_2 \cdot \text{season} + \beta_3 \cdot \text{cap.shape} \\+
 \beta_4 \cdot \text{cap.color} + \beta_5 \cdot \text{gill.color} + \beta_6 \cdot \text{stem.color} + \beta_7 \cdot \text{habitat} + \beta_8 \cdot (\text{habitat} \cdot \text{season}) \\ + \beta_9 \cdot (\text{cap.shape} \cdot \text{cap.color})
$$

### Confusion Matrix and ROC

class binary: edible = 0, poisonous = 1

```{r}
test_data$class_binary <- as.factor(test_data$class_binary)
predicted_values <- predict(full_model, test_data, type = "response")
test_data <- test_data |> 
  mutate(pred_prob = predicted_values)

roc_curve_data <- test_data |>
  roc_curve(class_binary, pred_prob, event_level = "second")
autoplot(roc_curve_data)

test_data_aug <- augment(full_model, newdata = test_data)
test_data_aug$class_binary <- as.factor(test_data_aug$class_binary)
test_data_aug |>
  roc_auc(class_binary, .fitted, event_level = "second")
```

```{r}
roc_curve_data |>
  filter(sensitivity <= 0.95) |>
  head()

threshold <- 0.255
test_data <- test_data |> 
  mutate(
    pred_class = case_when(
      pred_prob < threshold ~ 0,
      TRUE ~ 1
    )
  )


test_data$pred_class <- as.factor(test_data$pred_class)
conf_mat <- test_data |>
  yardstick::conf_mat(class_binary, pred_class)
autoplot(conf_mat, type = "heatmap")
```

The model is decent as the AUC is 0.816 which is closer to 1 than 0.5. In a specified model, the threshold is determined to be p = \_\_ because the false positives are more "expensive" than the false negatives as eating a poisonous mushroom can be detrimental to one's health. We are better to be overly cautious and let our model predict more false negatives for a trade off of less false positives. #Need code to determine the p value

## References
